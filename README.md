## ✅ 要件定義書（センサーデータ管理システム）

---

### 1. 🎯 **目的**
大量にCSV形式で保存されている**時系列センサーデータ**を、分析や可視化に使いやすい形へ整形・蓄積し、**DuckDBに保存**する。これにより、センサーデータの検索・抽出・分析を効率化する。

---

### 2. 👤 **対象ユーザー**
- 工場の技術者兼データ分析担当者

---

### 3. 📥 **ユーザー入力項目**
ユーザーはUIまたは設定ファイル等から、以下の情報を指定する：

| 項目名                 | 説明 |
|----------------------|------|
| `target_folder`       | センサーデータが保存されているフォルダパス（指定フォルダには1つの工場・機械のデータのみが存在） |
| `name_patterns`       | 対象ファイル名に含まれるキーワード（例：Cond, Vib, Tmp） |
| `encoding`            | CSVファイルの文字エンコーディング（例：shift_jis, utf-8） |
| `db_path`             | DuckDBファイルの保存先パス |
| `plant_name`          | ユーザーが指定する工場名（表示用名称） |
| `machine_no`          | ユーザーが指定する機械番号（表示用名称） |
| `label`               | 点検名やラベル名（例：2024年定期点検） |
| `label_description`   | ラベルの補足説明 |
| `events[]`            | イベント名のリスト（複数可） |
| `event_descriptions[]`| 各イベントの補足説明（複数可） |
| `event_start_times[]` | 各イベントの開始時刻（複数可） |
| `event_end_times[]`   | 各イベントの終了時刻（複数可） |

---

### 4. ⚙️ **処理フロー**

#### 4.1. ファイル検索・メタデータ抽出
- 指定フォルダ内のCSVおよびZIPファイルを検索
- ファイル名から以下の情報を抽出：
  - 工場コード（例：ABC → `plant_name_from_file`）
  - 機械番号（例：101 → `machine_no_from_file`）
  - 記録日・時刻（例：241121000000 → 2024年11月21日 00:00:00）
- 指定された名称パターン（例：Cond, Vib）でファイルをセット化

#### 4.2. グルーピング
- 同一の時間帯・機械・工場に対応するファイル群（Cond, Vib, Tmpなど）を**1セット**として扱う

#### 4.3. フィルタリング（※修正）
- ユーザー指定の**イベント時間**に基づいて対象ファイルを選別  
  → 指定フォルダ内には既に対象の工場・機械番号のデータしか存在しない前提
- ファイル名からの時間情報で、対象イベントとの重複があるものを抽出
- 処理済みのファイル期間はスキップ（ただし「再処理モード」も対応可能）

#### 4.4. データ整形・加工（※修正）
- 各ファイルセットを読み込み、以下の処理を実行：

  1. **ファイル統合**
     - 指定パターンに基づき、同じ時間帯の複数ファイル（例：Cond, Vib）を1つのセットとして統合

  2. **重複列の削除（縦持ち変換前）**
     - センサー項目の重複（同時刻・同パラメータ）を削除しユニーク化

  3. **縦持ちデータへの変換**
     - ワイド形式のCSVを縦持ち形式に変換（parameter_name, value）

  4. **イベントとの時刻マッチング**
     - イベント時間内のデータを切り出してイベント情報を付加

#### 4.5. DuckDBへの保存
- 以下のテーブルにデータを登録：

| テーブル名         | 内容 |
|------------------|------|
| `sensor_data`    | plant_name, machine_no, timestamp, parameter_name, value, event, label など |
| `sensor_metadata`| ファイル・イベント・ラベル・説明などの付加情報管理用 |

---

### 5. 📤 **出力**

| 出力項目             | 説明 |
|--------------------|------|
| `sensor_data` テーブル    | イベント単位で切り出されたセンサーデータ（縦持ち形式） |
| `sensor_metadata` テーブル| 工場・機械・イベント・ラベル等の付加情報 |
| データ抽出機能           | 以下の形式で取得可能：<br>・ワイド形式（時間×センサー項目）<br>・指定イベント/ラベルに対応するセンサーデータ<br>・センサー項目一覧、イベント一覧の取得 |

---

### 6. 🔖 補足仕様

- **ファイル名パースで対象期間の特定が可能**：中身を開かずに判定
- **ZIPファイルにも対応**
- **ユーザー指定の plant_name / machine_no** と、ファイル名から得られるコードは**別物として管理**
  - 例：
    - `plant_name`: 東京工場（ユーザー指定）
    - `plant_name_from_file`: ABC（ファイル名から取得）
- **再処理オプション**により、既存の処理済みファイルも再読み込み可能
